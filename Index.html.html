<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Super Bowl Squares LIVE (P2P, Single-File)</title>

  <!-- Single-file deps (CDN) -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg0:#071225;
      --bg1:#0b1a36;
      --sea:#69BE28;
      --pat:#C60C30;
      --glass: rgba(255,255,255,.09);
      --stroke: rgba(255,255,255,.18);
      --shadow: 0 30px 90px rgba(0,0,0,.45);
    }
    html, body { height: 100%; }
    body.modalOpen{ overflow: hidden; touch-action: none; }
    body{
      font-family: Montserrat, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: #eaf2ff;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(105,190,40,.22), transparent 60%),
        radial-gradient(900px 500px at 80% 0%, rgba(198,12,48,.24), transparent 55%),
        radial-gradient(900px 900px at 70% 90%, rgba(62,130,255,.20), transparent 60%),
        linear-gradient(135deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .mono{ font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .glass{
      background: var(--glass);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .btn{
      transition: transform .18s ease, filter .18s ease;
      will-change: transform;
      transform: translateZ(0);
    }
    .btn:hover{ transform: translateY(-1px) scale(1.02); filter: brightness(1.06); }
    .btn:active{ transform: translateY(0px) scale(.99); filter: brightness(.98); }

    .chip{ border: 1px solid rgba(255,255,255,.20); background: rgba(0,0,0,.20); }

    /* Grid */
    .gridwrap{ overflow:auto; -webkit-overflow-scrolling: touch; }
    table { border-collapse: separate; border-spacing: 6px; }

    .cell{
      width: 64px; height: 64px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.22);
      box-shadow: 0 12px 28px rgba(0,0,0,.35);
      display:flex; align-items:center; justify-content:center;
      text-align:center;
      user-select:none;
      cursor:pointer;
      will-change: transform;
      transform: translateZ(0);
      transition: transform .14s ease, background .14s ease, border-color .14s ease;
      position: relative;
      overflow: hidden;
      touch-action: manipulation;
    }

    .cell:hover{ transform: translateY(-1px) scale(1.03); border-color: rgba(255,255,255,.30); }
    .cell:active{ transform: translateY(0) scale(1.01); }
    .cell.claimed{ cursor: not-allowed; background: rgba(62,130,255,.26); border-color: rgba(120,190,255,.35); }
    .cell.winner{ background: linear-gradient(135deg, rgba(255,215,0,.28), rgba(255,140,0,.18)); border-color: rgba(255,215,0,.55); }

    .cell .shine{
      position:absolute; inset:-120% -120% auto auto;
      width: 220%; height: 220%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.20), transparent 55%);
      transform: rotate(18deg);
      pointer-events:none;
      opacity: .8;
    }

    .cell .txt{ font-weight: 800; font-size: 12px; line-height: 1.05; padding: 6px; }
    .cell .ava{ font-size: 22px; margin-bottom: 4px; display:block; }

    .hdrCell{ width:64px; height:64px; border-radius:14px; background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.16); display:flex; align-items:center; justify-content:center; font-weight:800; }

    @media (max-width: 768px){
      table { border-spacing: 4px; }
      .cell, .hdrCell { width: 52px; height: 52px; border-radius: 12px; }
      .cell .txt{ font-size: 11px; }
    }

    /* score bump */
    .bump { animation: bump .42s ease; }
    @keyframes bump{ 0%{ transform: translateZ(0) scale(1); } 40%{ transform: translateZ(0) scale(1.12); } 100%{ transform: translateZ(0) scale(1); } }

    /* Modal (iOS-safe) */
    .modalBack { background: rgba(0,0,0,.60); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    .modalFrame{ position: fixed; inset: 0; height: 100dvh; width: 100vw; }
    .modalCard{ width: min(720px, 100%); max-height: calc(100dvh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 24px); overflow: hidden; display:flex; flex-direction:column; }
    .modalHeader{ position: sticky; top: 0; z-index: 1; background: rgba(10,10,18,.55); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border-bottom: 1px solid rgba(255,255,255,.12);} 
    .modalBody{ overflow: auto; -webkit-overflow-scrolling: touch; padding-bottom: max(16px, env(safe-area-inset-bottom)); }
    .modalClose{ min-width: 44px; min-height: 44px; }

    /* Toast */
    .toast { animation: toastIn .35s ease forwards; }
    @keyframes toastIn { from{ transform: translateY(18px); opacity: 0; } to{ transform: translateY(0); opacity: 1; } }

    /* Winner fly */
    .fly { position: fixed; left: 50%; top: -50px; transform: translateX(-50%); z-index: 60; pointer-events:none; }
    .flyInner { animation: fly 3.2s ease forwards; }
    @keyframes fly {
      0% { transform: translateY(-80px) scale(.7); opacity: 0; }
      15%{ opacity: 1; }
      55%{ transform: translateY(26vh) scale(1.05); opacity: 1; }
      100%{ transform: translateY(60vh) scale(1.25); opacity: 0; }
    }

    /* Help button */
    #helpBtn{
      position: fixed;
      right: 16px;
      bottom: calc(16px + env(safe-area-inset-bottom));
      z-index: 70;
      width: 56px;
      height: 56px;
      border-radius: 999px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.22);
      box-shadow: 0 16px 40px rgba(0,0,0,.45);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      display:flex; align-items:center; justify-content:center;
      font-weight: 900;
      cursor:pointer;
      transition: transform .18s ease, filter .18s ease;
      will-change: transform;
      transform: translateZ(0);
    }
    #helpBtn:hover{ transform: translateY(-1px) scale(1.06); filter: brightness(1.08); }
    #helpBtn:active{ transform: translateY(0) scale(1.02); }

    /* Reconnect banner */
    .banner { background: linear-gradient(90deg, rgba(62,130,255,.25), rgba(105,190,40,.16), rgba(198,12,48,.16)); border:1px solid rgba(255,255,255,.20); }

    /* Tap Frenzy */
    .bigTap { width: 220px; height: 220px; border-radius: 999px; box-shadow: 0 30px 80px rgba(0,0,0,.50); }
    .bigTap:active{ transform: scale(.98); }
    .miniPulse { animation: miniPulse 1.2s ease-in-out infinite; }
    @keyframes miniPulse{ 0%,100%{ filter: brightness(1.0); transform: scale(1);} 50%{ filter: brightness(1.12); transform: scale(1.03);} }

    @media (prefers-reduced-motion: reduce) {
      .btn, .cell, #helpBtn { transition: none; }
      .bump, .toast, .flyInner, .miniPulse { animation: none !important; }
    }
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto p-4 sm:p-6">

    <!-- Header -->
    <div class="glass rounded-3xl p-5 sm:p-7 mb-5">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <div class="text-sm opacity-85">Super Bowl Squares ‚Ä¢ P2P ‚Ä¢ Single HTML</div>
          <div class="text-2xl sm:text-3xl font-extrabold tracking-tight">LIVE Squares Party Game</div>
          <div class="text-sm opacity-80 mt-1">No trivia, no gambling‚Äîpoints + family mini-games.</div>
        </div>
        <div class="flex flex-wrap gap-2 items-center justify-start sm:justify-end">
          <span id="netChip" class="chip text-xs px-3 py-2 rounded-full">Idle</span>
          <button id="soundBtn" class="btn chip text-xs px-3 py-2 rounded-full" type="button">üîä Enable sound</button>
          <button id="resetLocalBtn" class="btn chip text-xs px-3 py-2 rounded-full" type="button">üßπ Clear this device</button>
        </div>
      </div>
    </div>

    <!-- Mode select -->
    <div id="mode" class="glass rounded-3xl p-7 sm:p-10">
      <div class="grid md:grid-cols-2 gap-6 md:gap-10 items-start">
        <div>
          <div class="text-4xl font-extrabold leading-tight">Host or join in seconds.</div>
          <div class="opacity-85 mt-3">Host shares a 4-letter code. Players join on phones, claim squares, watch winners light up with confetti.</div>
          <div class="mt-6 flex gap-3 flex-wrap">
            <button id="hostBtn" class="btn px-6 py-4 rounded-2xl font-extrabold text-lg bg-gradient-to-r from-emerald-500 to-lime-500 text-black" type="button">üéôÔ∏è Host game</button>
            <button id="joinBtn" class="btn px-6 py-4 rounded-2xl font-extrabold text-lg bg-gradient-to-r from-sky-500 to-indigo-500 text-black" type="button">üì± Join game</button>
          </div>
          <div class="mt-5 text-sm opacity-80">Tip: Use GitHub Pages or a local server (not file://) for best WebRTC behavior.</div>
        </div>

        <div class="glass rounded-3xl p-6 border border-white/10">
          <div class="font-extrabold text-xl">Your player profile</div>
          <div class="text-sm opacity-80 mt-1">Saved on this device so reconnects pick up where you left off.</div>
          <div class="mt-5">
            <label class="text-sm font-semibold opacity-90">Name</label>
            <input id="nameInput" class="mt-2 w-full rounded-2xl bg-black/30 border border-white/20 px-4 py-3" placeholder="e.g., Alex" maxlength="18" />
          </div>
          <div class="mt-5">
            <div class="flex items-center justify-between">
              <label class="text-sm font-semibold opacity-90">Avatar</label>
              <div id="avatarChosen" class="mono text-sm opacity-90"></div>
            </div>
            <div id="avatarGrid" class="mt-3 grid grid-cols-8 gap-2"></div>
          </div>
          <div class="mt-5">
            <label class="text-sm font-semibold opacity-90">Join code</label>
            <input id="codeInput" class="mt-2 w-full rounded-2xl bg-black/30 border border-white/20 px-4 py-3 uppercase mono" placeholder="ABCD" maxlength="4" />
          </div>
          <button id="joinNowBtn" class="btn mt-5 w-full px-6 py-4 rounded-2xl font-extrabold text-lg bg-gradient-to-r from-sky-500 to-indigo-500 text-black" type="button">Connect</button>
        </div>
      </div>
    </div>

    <!-- Host panel -->
    <div id="hostPanel" class="hidden">
      <div class="glass rounded-3xl p-6 sm:p-8 mt-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
          <div>
            <div class="text-sm opacity-85">Room code</div>
            <div class="text-4xl sm:text-5xl font-extrabold mono" id="roomCode">----</div>
            <div class="text-sm opacity-80 mt-1">Share this code with players.</div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button id="shuffleBtn" class="btn px-4 py-3 rounded-2xl font-extrabold bg-white/10 border border-white/20" type="button">üé≤ Shuffle numbers</button>
            <button id="autoBtn" class="btn px-4 py-3 rounded-2xl font-extrabold bg-white/10 border border-white/20" type="button">üõ∞Ô∏è Auto scores: OFF</button>
            <button id="tapBtn" class="btn px-4 py-3 rounded-2xl font-extrabold bg-white/10 border border-white/20" type="button">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Tap Frenzy</button>
            <button id="resetRoomBtn" class="btn px-4 py-3 rounded-2xl font-extrabold bg-white/10 border border-white/20" type="button">üßº Reset room</button>
          </div>
        </div>

        <div id="hostStatus" class="mt-4 text-sm opacity-85"></div>

        <div class="grid lg:grid-cols-3 gap-4 mt-6">
          <div class="glass rounded-2xl p-4">
            <div class="font-extrabold">Scoreboard</div>
            <div class="text-xs opacity-75 mt-1">Auto uses ESPN scoreboard via AllOrigins; manual override always available.</div>

            <div class="mt-4 grid grid-cols-2 gap-3">
              <div class="glass rounded-2xl p-3 border border-white/10">
                <div class="text-xs opacity-80">Seahawks</div>
                <div id="seaScore" class="text-3xl font-extrabold mono">0</div>
              </div>
              <div class="glass rounded-2xl p-3 border border-white/10">
                <div class="text-xs opacity-80">Patriots</div>
                <div id="patScore" class="text-3xl font-extrabold mono">0</div>
              </div>
            </div>

            <div class="mt-4 grid grid-cols-2 gap-2">
              <button id="lockQ1" class="btn px-3 py-3 rounded-2xl font-extrabold bg-black/20 border border-white/20" type="button">Lock Q1</button>
              <button id="lockQ2" class="btn px-3 py-3 rounded-2xl font-extrabold bg-black/20 border border-white/20" type="button">Lock Q2</button>
              <button id="lockQ3" class="btn px-3 py-3 rounded-2xl font-extrabold bg-black/20 border border-white/20" type="button">Lock Q3</button>
              <button id="lockF" class="btn px-3 py-3 rounded-2xl font-extrabold bg-black/20 border border-white/20" type="button">Lock Final</button>
            </div>

            <div class="mt-4 grid grid-cols-2 gap-3">
              <div>
                <label class="text-xs opacity-80">Manual SEA</label>
                <input id="manualSea" type="number" min="0" max="99" class="mt-1 w-full rounded-2xl bg-black/30 border border-white/20 px-3 py-2 mono" />
              </div>
              <div>
                <label class="text-xs opacity-80">Manual NE</label>
                <input id="manualPat" type="number" min="0" max="99" class="mt-1 w-full rounded-2xl bg-black/30 border border-white/20 px-3 py-2 mono" />
              </div>
            </div>
            <button id="applyManual" class="btn mt-3 w-full px-4 py-3 rounded-2xl font-extrabold bg-gradient-to-r from-amber-300 to-orange-400 text-black" type="button">Apply manual score</button>
          </div>

          <div class="glass rounded-2xl p-4">
            <div class="flex items-center justify-between">
              <div class="font-extrabold">Prizes</div>
              <div class="chip text-xs px-3 py-1 rounded-full">family-friendly</div>
            </div>
            <div class="text-xs opacity-75 mt-1">Each locked period awards 1 main winner + optional bonus winners.</div>
            <div class="mt-4">
              <label class="text-xs opacity-80">Bonus winners per period</label>
              <input id="bonusCount" type="number" min="0" max="5" class="mt-1 w-full rounded-2xl bg-black/30 border border-white/20 px-3 py-2 mono" value="1" />
            </div>

            <div class="mt-4">
              <div class="text-xs opacity-80">Prize deck</div>
              <div id="prizeDeck" class="mt-2 text-sm opacity-90 leading-relaxed"></div>
            </div>

            <div class="mt-4">
              <div class="text-xs opacity-80">Winners (locked)</div>
              <div id="winners" class="mt-2 text-sm"></div>
            </div>
          </div>

          <div class="glass rounded-2xl p-4">
            <div class="font-extrabold">Leaderboard</div>
            <div class="text-xs opacity-75 mt-1">Points: Q1/Q2/Q3 = 1, Final = 2. Bonus prize winners = 1.</div>
            <div id="leaders" class="mt-4 space-y-2"></div>
            <div class="mt-4 text-xs opacity-70">Players online are marked with ‚óè.</div>
          </div>
        </div>

      </div>
    </div>

    <!-- Player banner + grid -->
    <div id="playArea" class="hidden">
      <div id="reconnectBanner" class="hidden banner rounded-2xl p-3 mt-6">
        <div class="flex items-center justify-between">
          <div class="text-sm font-semibold">Reconnecting‚Ä¶</div>
          <div id="reconnectMsg" class="text-xs opacity-80"></div>
        </div>
      </div>

      <div class="glass rounded-3xl p-5 sm:p-7 mt-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
          <div class="flex items-center gap-3">
            <div class="text-3xl" id="meAvatar">üôÇ</div>
            <div>
              <div class="font-extrabold" id="meName">Player</div>
              <div class="text-xs opacity-80">Room: <span class="mono" id="meRoom">----</span></div>
            </div>
          </div>

          <div class="flex flex-wrap gap-2 items-center">
            <span class="chip text-xs px-3 py-2 rounded-full">SEA row digits vs NE col digits</span>
            <span class="chip text-xs px-3 py-2 rounded-full">Tap a square to claim</span>
          </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-4 mt-6">
          <div class="glass rounded-2xl p-4">
            <div class="font-extrabold">Live score</div>
            <div class="mt-3 grid grid-cols-2 gap-3">
              <div class="glass rounded-2xl p-3 border border-white/10">
                <div class="text-xs opacity-80">Seahawks</div>
                <div id="pSea" class="text-3xl font-extrabold mono">0</div>
              </div>
              <div class="glass rounded-2xl p-3 border border-white/10">
                <div class="text-xs opacity-80">Patriots</div>
                <div id="pPat" class="text-3xl font-extrabold mono">0</div>
              </div>
            </div>
            <div id="pStatus" class="text-xs opacity-80 mt-3"></div>
          </div>

          <div class="glass rounded-2xl p-4">
            <div class="font-extrabold">Your points</div>
            <div id="pPoints" class="text-5xl font-extrabold mono mt-4">0</div>
            <div class="text-xs opacity-75 mt-2">Winners are locked by the host (auto or manual).</div>
          </div>

          <div class="glass rounded-2xl p-4">
            <div class="font-extrabold">Quick help</div>
            <div class="text-sm opacity-85 mt-2">If your phone locks, just come back‚Äîyour squares and points will resync.</div>
            <button id="helpBtn2" class="btn mt-4 w-full px-4 py-3 rounded-2xl font-extrabold bg-white/10 border border-white/20" type="button">Open rules</button>
          </div>
        </div>

        <div class="mt-6">
          <div class="flex items-center justify-between">
            <div class="font-extrabold">Squares grid</div>
            <div class="text-xs opacity-80">Numbers show after host shuffles.</div>
          </div>
          <div class="gridwrap mt-4">
            <table id="gridTable"></table>
          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- Help floating -->
  <button id="helpBtn" type="button" aria-label="Help">?</button>

  <!-- Rules modal -->
  <div id="rulesModal" class="hidden modalFrame z-50 modalBack flex items-end sm:items-center justify-center p-3 sm:p-4" role="dialog" aria-modal="true" aria-labelledby="rulesTitle">
    <div class="glass rounded-3xl modalCard border border-white/15">
      <div class="modalHeader rounded-t-3xl px-5 sm:px-7 py-4">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div id="rulesTitle" class="text-2xl sm:text-3xl font-extrabold">How to play</div>
            <div class="text-sm opacity-85 mt-1">Squares is luck + drama. No football knowledge needed.</div>
          </div>
          <button id="closeRules" class="btn modalClose px-3 py-2 rounded-2xl bg-white/10 border border-white/20" type="button" aria-label="Close rules">Close</button>
        </div>
      </div>

      <div class="modalBody px-5 sm:px-7 py-5">
        <div class="space-y-4">
          <div class="glass rounded-2xl p-4">
            <div class="font-extrabold">Goal</div>
            <div class="opacity-90 mt-1">Claim squares and earn points when your square matches the last digits of the score at the end of each period.</div>
          </div>

          <div class="grid sm:grid-cols-2 gap-4">
            <div class="glass rounded-2xl p-4">
              <div class="font-extrabold">Step 1 ‚Äî Claim</div>
              <div class="opacity-90 mt-1">Tap any ‚Äú?‚Äù square to claim it. Your avatar appears.</div>
            </div>
            <div class="glass rounded-2xl p-4">
              <div class="font-extrabold">Step 2 ‚Äî Numbers</div>
              <div class="opacity-90 mt-1">Host shuffles 0‚Äì9 along rows (SEA) and columns (NE).</div>
            </div>
            <div class="glass rounded-2xl p-4">
              <div class="font-extrabold">Step 3 ‚Äî Winners</div>
              <div class="opacity-90 mt-1">Last digit SEA score selects row; last digit NE score selects column.</div>
            </div>
            <div class="glass rounded-2xl p-4">
              <div class="font-extrabold">Points & prizes</div>
              <div class="opacity-90 mt-1">Q1/Q2/Q3 = 1 pt, Final = 2 pts. Bonus winners get +1.</div>
            </div>
          </div>

          <div class="glass rounded-2xl p-4">
            <div class="font-extrabold">Mini-game (family)</div>
            <div class="opacity-90 mt-1">Tap Frenzy: when the host starts it, tap fast for 10 seconds. Top taps get +1 point (ties share).</div>
          </div>

          <div class="flex gap-3 justify-end">
            <button id="rulesOk" class="btn px-5 py-3 rounded-2xl font-extrabold bg-gradient-to-r from-emerald-500 to-lime-500 text-black" type="button">Got it</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast area -->
  <div id="toastArea" class="fixed bottom-4 left-4 z-50 space-y-2" style="padding-bottom: env(safe-area-inset-bottom)"></div>

  <!-- Tap Frenzy overlay (player) -->
  <div id="mini" class="hidden modalFrame z-50 modalBack flex items-end sm:items-center justify-center p-3 sm:p-4" role="dialog" aria-modal="true" aria-labelledby="miniTitle">
    <div class="glass rounded-3xl modalCard border border-white/15">
      <div class="modalHeader rounded-t-3xl px-5 sm:px-7 py-4">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div id="miniTitle" class="text-2xl sm:text-3xl font-extrabold">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Tap Frenzy</div>
            <div class="text-sm opacity-85 mt-1">Tap the big button before the timer hits 0.</div>
          </div>
          <button id="miniClose" class="btn modalClose px-3 py-2 rounded-2xl bg-white/10 border border-white/20" type="button">Hide</button>
        </div>
      </div>

      <div class="modalBody px-5 sm:px-7 py-5 text-center">
        <div class="mt-2 flex items-center justify-center">
          <div id="miniTimer" class="mono text-6xl font-extrabold">10</div>
        </div>

        <div class="mt-6 flex items-center justify-center">
          <button id="tapBig" class="btn bigTap miniPulse bg-gradient-to-r from-emerald-400 to-sky-500 text-black font-extrabold text-3xl" type="button">TAP</button>
        </div>

        <div class="mt-5 text-xl font-semibold">Your taps: <span id="myTaps" class="mono">0</span></div>
        <div id="miniHint" class="text-xs opacity-75 mt-2">(We‚Äôll show winners when it ends.)</div>
      </div>
    </div>
  </div>

<script>
(() => {
  // Utilities
  const $ = (id) => document.getElementById(id);
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const now = () => Date.now();
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const randInt = (a, b) => {
    const u = new Uint32Array(1);
    crypto.getRandomValues(u);
    return a + (u[0] % (b - a + 1));
  };
  const shuffle = (arr) => {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = randInt(0, i);
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  };
  const makeToken = () => {
    const u = new Uint8Array(12);
    crypto.getRandomValues(u);
    return Array.from(u).map(x => x.toString(16).padStart(2,'0')).join('');
  };
  const code4 = () => {
    const letters = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
    return Array.from({length:4}, () => letters[randInt(0, letters.length-1)]).join('');
  };
  const keyOf = (r,c) => `${r}-${c}`;

  function toast(msg, kind='info'){
    const el = document.createElement('div');
    el.className = `toast glass rounded-2xl px-4 py-3 text-sm border ${kind==='err'?'border-red-400/40':'border-white/20'}`;
    el.textContent = msg;
    $('toastArea').appendChild(el);
    setTimeout(() => el.remove(), 3600);
  }

  // Audio (gesture-gated)
  let audioCtx = null;
  let soundEnabled = false;
  function ensureAudio(){
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
  }
  function beep(freq=740, dur=0.12, gainVal=0.18){
    if (!soundEnabled) return;
    ensureAudio();
    const t = audioCtx.currentTime;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sine';
    o.frequency.setValueAtTime(freq, t);
    g.gain.setValueAtTime(gainVal, t);
    g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(t);
    o.stop(t + dur);
  }
  function ding(){ beep(880, 0.10, 0.22); }
  function cheer(){
    if (!soundEnabled) return;
    ensureAudio();
    const seq = [523, 659, 784, 1046];
    seq.forEach((f, i) => setTimeout(() => beep(f, 0.16, 0.16), i*90));
  }

  $('soundBtn').addEventListener('click', () => {
    soundEnabled = !soundEnabled;
    if (soundEnabled) ensureAudio();
    $('soundBtn').textContent = soundEnabled ? 'üîá Sound on' : 'üîä Enable sound';
    toast(soundEnabled ? 'Sound enabled' : 'Sound muted');
  });

  // Confetti
  function fireConfetti(originX=0.5){
    const mobile = matchMedia('(max-width: 768px)').matches;
    confetti({
      particleCount: mobile ? 55 : 120,
      spread: 70,
      startVelocity: mobile ? 28 : 42,
      origin: { x: clamp(originX, 0.1, 0.9), y: 0.45 },
      scalar: mobile ? 0.85 : 1,
      ticks: mobile ? 160 : 230,
      resize: true,
      useWorker: true,
      disableForReducedMotion: true
    });
  }

  function flyWinner(text){
    const wrap = document.createElement('div');
    wrap.className = 'fly';
    const inner = document.createElement('div');
    inner.className = 'flyInner glass rounded-3xl px-5 py-4 font-extrabold text-lg sm:text-xl';
    inner.style.border = '1px solid rgba(255,215,0,.35)';
    inner.style.background = 'rgba(255,215,0,.12)';
    inner.textContent = text;
    wrap.appendChild(inner);
    document.body.appendChild(wrap);
    setTimeout(() => wrap.remove(), 3300);
  }

  // Persistent profile
  const LS_KEY = 'sbSquares_v2';
  function loadProfile(){
    try{ const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : null; } catch { return null; }
  }
  function saveProfile(p){ localStorage.setItem(LS_KEY, JSON.stringify(p)); }
  function clearProfile(){ localStorage.removeItem(LS_KEY); }

  const AVATARS = ['üèà','ü¶Ö','ü¶à','üêª','ü¶Å','üêØ','üêº','ü¶ä','ü¶Ñ','üê≤','‚≠ê','üî•','üéØ','üéÆ','üéâ','üèÜ','üòé','ü§ñ','üßÅ','üçï','üçø','üßÉ','üéµ','üü¢','üî¥','üü¶','üíö','‚ù§Ô∏è','üß†','üß©','üåü','üöÄ'];
  let my = { token: makeToken(), name: 'Player', avatar: 'üèà', lastRoom: '' };
  const loaded = loadProfile();
  if (loaded?.token) my = { ...my, ...loaded };

  $('nameInput').value = my.name || '';
  $('codeInput').value = (my.lastRoom || '').toUpperCase();

  function renderAvatars(){
    $('avatarGrid').innerHTML = AVATARS.map(a => {
      const sel = a === my.avatar;
      return `<button type="button" class="btn aspect-square rounded-2xl border ${sel?'border-amber-300/70 bg-amber-300/15':'border-white/20 bg-white/5'} flex items-center justify-center text-2xl" data-ava="${a}" aria-label="avatar ${a}">${a}</button>`;
    }).join('');
    $('avatarChosen').textContent = `Selected: ${my.avatar}`;
    $('avatarGrid').querySelectorAll('button').forEach(b => {
      b.addEventListener('click', () => {
        my.avatar = b.dataset.ava;
        saveProfile(my);
        renderAvatars();
      });
    });
  }
  renderAvatars();

  $('resetLocalBtn').addEventListener('click', () => { clearProfile(); location.reload(); });

  // Modal
  function openRules(){ document.body.classList.add('modalOpen'); $('rulesModal').classList.remove('hidden'); }
  function closeRules(){ $('rulesModal').classList.add('hidden'); document.body.classList.remove('modalOpen'); }

  function openMini(){ document.body.classList.add('modalOpen'); $('mini').classList.remove('hidden'); }
  function closeMini(){ $('mini').classList.add('hidden'); document.body.classList.remove('modalOpen'); }

  $('helpBtn').addEventListener('click', openRules);
  $('helpBtn2').addEventListener('click', openRules);
  $('closeRules').addEventListener('click', closeRules);
  $('rulesOk').addEventListener('click', closeRules);
  $('rulesModal').addEventListener('click', (e) => { if (e.target && e.target.id === 'rulesModal') closeRules(); });
  $('mini').addEventListener('click', (e) => { if (e.target && e.target.id === 'mini') closeMini(); });
  $('miniClose').addEventListener('click', closeMini);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeRules(); closeMini(); } });

  // Networking (PeerJS)
  let mode = 'menu'; // menu | host | player
  let peer = null;
  let conn = null; // player -> host
  let conns = new Map(); // host: token -> DataConnection

  function setNetChip(txt){ $('netChip').textContent = txt; }
  function peerError(err){ console.error(err); toast(err?.message || String(err), 'err'); }

  // Host authoritative state
  let state = null;
  function newState(roomCode){
    return {
      v: 2,
      roomCode,
      createdAt: now(),
      numbers: { sea: [], pat: [] },
      squares: {}, // key -> token
      players: {}, // token -> {name, avatar, points, lastSeen, online}
      score: { sea: 0, pat: 0 },
      statusText: 'Waiting for shuffle‚Ä¶',
      locks: { q1: null, q2: null, q3: null, final: null },
      winners: {},
      settings: { bonusPer: 1 },
      mini: null,
      auto: { enabled:false, lastFetch:0, detail:'' }
    };
  }

  const PERIODS = ['q1','q2','q3','final'];
  const PERIOD_LABEL = { q1:'Q1', q2:'Q2', q3:'Q3', final:'FINAL' };

  function broadcast(){
    if (mode !== 'host') return;
    const msg = { t:'state', state };
    for (const [token, c] of conns.entries()) if (c?.open) c.send(msg);
  }
  function sendToHost(msg){ if (conn?.open) conn.send(msg); }

  function upsertPlayer(token, name, avatar){
    if (!state.players[token]) state.players[token] = { name, avatar, points: 0, lastSeen: now(), online: true };
    state.players[token].name = name;
    state.players[token].avatar = avatar;
    state.players[token].lastSeen = now();
    state.players[token].online = true;
  }

  function markOfflineSweeper(){
    if (mode !== 'host') return;
    const t = now();
    for (const token in state.players){
      const p = state.players[token];
      p.online = (t - (p.lastSeen || 0)) < 20000;
    }
  }

  // Rendering
  function renderPrizeDeck(){
    const deck = [
      'üçø Choose the next snack','üéµ Pick the next song','üßÉ Choose a drink (non-alcoholic)','üé¨ Pick the next trailer',
      'üßÅ Dessert captain','üß† Tell a clean joke','üï∫ 10-second dance','üéÆ Choose next mini-game','‚≠ê Give a compliment','üß© Quick riddle'
    ];
    $('prizeDeck').innerHTML = deck.map(x => `‚Ä¢ ${x}`).join('<br>');
  }

  function renderWinners(){
    if (mode !== 'host') return;
    const w = state.winners || {};
    const lines = [];
    for (const per of PERIODS){
      if (!w[per]) continue;
      const main = w[per].main;
      if (main?.token){
        const mainP = state.players[main.token];
        lines.push(`<div class="mt-2"><div class="font-extrabold">${PERIOD_LABEL[per]}: ${mainP?.avatar||'üèà'} ${mainP?.name||'Unknown'} (${main.key}) ‚Äî ${main.prize}</div></div>`);
      } else {
        lines.push(`<div class="mt-2"><div class="font-extrabold">${PERIOD_LABEL[per]}: Unclaimed (${main.key})</div></div>`);
      }
      for (const b of (w[per].bonus||[])){
        const bp = state.players[b.token];
        lines.push(`<div class="opacity-90">Bonus: ${bp?.avatar||'‚≠ê'} ${bp?.name||'Unknown'} (${b.key}) ‚Äî ${b.prize}</div>`);
      }
    }
    $('winners').innerHTML = lines.length ? lines.join('') : '<div class="opacity-80">No locked winners yet.</div>';
  }

  function renderLeaders(){
    const players = Object.entries(state.players || {}).map(([token,p]) => ({ token, ...p }));
    players.sort((a,b) => (b.points||0) - (a.points||0) || (b.lastSeen||0)-(a.lastSeen||0));

    const list = players.slice(0, 14).map((p,i) => {
      const dot = p.online ? '<span class="text-emerald-400">‚óè</span>' : '<span class="text-white/35">‚óè</span>';
      const rank = i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':`#${i+1}`;
      return `<div class="glass rounded-2xl px-3 py-2 flex items-center gap-2">
        <div class="w-10 text-center">${rank}</div>
        <div class="text-2xl">${p.avatar||'üèà'}</div>
        <div class="flex-1 min-w-0">
          <div class="font-extrabold truncate">${p.name||'Player'}</div>
          <div class="text-xs opacity-70">${dot} ${p.online?'online':'away'}</div>
        </div>
        <div class="mono text-xl font-extrabold">${p.points||0}</div>
      </div>`;
    }).join('');

    if (mode === 'host') $('leaders').innerHTML = list || '<div class="opacity-80">No players yet.</div>';

    const meP = state.players?.[my.token];
    if (meP) $('pPoints').textContent = meP.points || 0;
  }

  function bump(el){ el.classList.remove('bump'); void el.offsetWidth; el.classList.add('bump'); }

  function renderScore(){
    if (!state) return;
    if (mode === 'host'){
      const sea = $('seaScore');
      const pat = $('patScore');
      const s0 = sea.textContent, p0 = pat.textContent;
      sea.textContent = state.score.sea;
      pat.textContent = state.score.pat;
      if (s0 !== String(state.score.sea)) bump(sea);
      if (p0 !== String(state.score.pat)) bump(pat);
      $('hostStatus').textContent = state.statusText || '';
    }
    $('pSea').textContent = state.score.sea;
    $('pPat').textContent = state.score.pat;
    $('pStatus').textContent = state.auto?.enabled ? (state.auto.detail || 'Auto score active') : 'Waiting for host updates.';
  }

  function cellContent(token){
    const p = state.players?.[token];
    if (!p) return '<div class="txt">?</div>';
    const safeName = (p.name || 'Player').slice(0,10);
    return `<div class="txt"><span class="ava">${p.avatar||'üèà'}</span>${safeName}</div>`;
  }

  function renderGrid(){
    if (!state) return;
    const sea = state.numbers.sea;
    const pat = state.numbers.pat;
    const haveNums = sea.length===10 && pat.length===10;

    const table = $('gridTable');
    let html = '';

    html += '<tr>';
    html += `<td><div class="hdrCell mono">SEA</div></td>`;
    for (let c=0; c<10; c++) html += `<td><div class="hdrCell mono" style="border-color: rgba(198,12,48,.35)">${haveNums ? pat[c] : '?'}</div></td>`;
    html += '</tr>';

    for (let r=0; r<10; r++){
      html += '<tr>';
      html += `<td><div class="hdrCell mono" style="border-color: rgba(105,190,40,.35)">${haveNums ? sea[r] : '?'}</div></td>`;
      for (let c=0; c<10; c++){
        const key = keyOf(r,c);
        const owner = state.squares[key];
        const isClaimed = !!owner;
        const isWin = Object.values(state.winners||{}).some(per => {
          if (!per) return false;
          if (per.main?.key === key) return true;
          return (per.bonus||[]).some(b => b.key===key);
        });

        const cls = ['cell'];
        if (isClaimed) cls.push('claimed');
        if (isWin) cls.push('winner');

        html += `<td><div class="${cls.join(' ')}" data-key="${key}" role="button" tabindex="0" aria-label="Square ${key}">
            <div class="shine"></div>
            ${isClaimed ? cellContent(owner) : '<div class="txt">?</div>'}
          </div></td>`;
      }
      html += '</tr>';
    }

    table.innerHTML = html;
    table.querySelectorAll('.cell').forEach(el => {
      el.addEventListener('click', () => onCellTap(el.dataset.key));
      el.addEventListener('keydown', (e) => { if (e.key==='Enter' || e.key===' ') onCellTap(el.dataset.key); });
    });
  }

  function renderAll(){ renderPrizeDeck(); renderGrid(); renderScore(); renderWinners(); renderLeaders(); }

  // Claim
  function onCellTap(key){
    if (!state) return;
    if (mode !== 'player') { toast('Join from a phone to claim squares.'); return; }

    if (state.squares[key]){ ding(); toast('That square is already claimed.'); return; }

    state.squares[key] = my.token; // optimistic
    renderGrid();
    ding();
    sendToHost({ t:'claim', token: my.token, key });
  }

  // Winner computation (host)
  const PRIZES = ['üçø Snack Captain','üéµ DJ for 1 song','‚≠ê High-Five Champion','üßÅ Dessert Pick','üé¨ Choose a trailer','üßÉ Drink Picker','üï∫ 10-second Dance','üß† Clean Joke','üéØ Target Toss','üèÜ Glory Bragging Rights'];
  const pickPrize = () => PRIZES[randInt(0, PRIZES.length-1)];
  const lastDigit = (n) => Math.abs(parseInt(n||0,10)) % 10;

  function computeKeyFromScore(seaScore, patScore){
    const seaD = lastDigit(seaScore);
    const patD = lastDigit(patScore);
    const r = state.numbers.sea.indexOf(seaD);
    const c = state.numbers.pat.indexOf(patD);
    if (r<0 || c<0) return null;
    return keyOf(r,c);
  }

  function chooseBonusWinners(excludeKey, count){
    const claimedKeys = Object.keys(state.squares || {});
    const pool = claimedKeys.filter(k => k !== excludeKey);
    const winners = [];
    let tries = 0;
    while (winners.length < count && pool.length && tries < 300){
      tries++;
      const idx = randInt(0, pool.length-1);
      const key = pool.splice(idx, 1)[0];
      const token = state.squares[key];
      if (!token) continue;
      winners.push({ token, key, prize: pickPrize() });
    }
    return winners;
  }

  function awardPeriod(period, seaScore, patScore){
    if (mode !== 'host') return;
    if (!PERIODS.includes(period)) return;
    if (!state.numbers.sea.length || !state.numbers.pat.length) { toast('Shuffle numbers first.'); return; }

    const key = computeKeyFromScore(seaScore, patScore);
    if (!key){ state.statusText = `Cannot compute winner for ${PERIOD_LABEL[period]} yet.`; return; }

    const mainToken = state.squares[key];
    if (!mainToken){
      state.statusText = `${PERIOD_LABEL[period]} locked: winning square ${key} is unclaimed.`;
      state.winners[period] = { main: { token: null, key, prize: 'Unclaimed' }, bonus: [] };
      state.locks[period] = { sea: seaScore, pat: patScore, at: now() };
      return;
    }

    if (state.winners[period]?.main?.key === key && state.winners[period]?.main?.token === mainToken) {
      state.statusText = `${PERIOD_LABEL[period]} already locked.`;
      return;
    }

    const bonusCount = clamp(parseInt(state.settings.bonusPer || 0, 10) || 0, 0, 5);
    const bonus = chooseBonusWinners(key, bonusCount);

    state.winners[period] = { main: { token: mainToken, key, prize: pickPrize() }, bonus };
    state.locks[period] = { sea: seaScore, pat: patScore, at: now() };

    const mainPts = (period === 'final') ? 2 : 1;
    state.players[mainToken].points = (state.players[mainToken].points || 0) + mainPts;
    for (const b of bonus){ if (state.players[b.token]) state.players[b.token].points = (state.players[b.token].points || 0) + 1; }

    const p = state.players[mainToken];
    state.statusText = `${PERIOD_LABEL[period]} locked! ${p.avatar} ${p.name} wins.`;

    cheer();
    fireConfetti(0.5);
    flyWinner(`${PERIOD_LABEL[period]} Winner: ${p.avatar} ${p.name}`);
  }

  // Tap Frenzy
  function startMini(durationSec=10){
    if (mode !== 'host') return;
    const endsAt = now() + durationSec*1000;
    state.mini = { type:'tap', active:true, endsAt, taps:{} };
    state.statusText = 'Tap Frenzy started!';
    broadcast();
    setTimeout(() => { if (mode==='host' && state.mini?.active) endMini(); }, durationSec*1000 + 150);
  }

  function endMini(){
    if (mode !== 'host') return;
    const taps = state.mini?.taps || {};
    const entries = Object.entries(taps);
    state.mini.active = false;

    if (!entries.length){ state.statusText = 'Tap Frenzy ended (no taps).'; broadcast(); return; }

    let max = 0;
    for (const [,count] of entries) max = Math.max(max, count||0);
    const winners = entries.filter(([,count]) => (count||0) === max && max>0).map(([token]) => token);

    if (winners.length){
      for (const token of winners){ if (state.players[token]) state.players[token].points = (state.players[token].points||0) + 1; }
      const names = winners.map(t => `${state.players[t]?.avatar||'‚≠ê'} ${state.players[t]?.name||'Player'}`).join(', ');
      state.statusText = `Tap Frenzy winners (+1): ${names}`;
      cheer();
      fireConfetti(0.5);
      flyWinner(`Tap Frenzy: ${names}`);
    } else {
      state.statusText = 'Tap Frenzy ended.';
    }

    broadcast();
  }

  // Auto score fetch
  let autoTimer = null;

  async function fetchScore(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    const dateStr = `${y}${m}${day}`;

    const target = `https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard?dates=${dateStr}&seasontype=3`;
    const url = `https://api.allorigins.win/raw?url=${encodeURIComponent(target)}`;

    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error('Score fetch failed');
    const json = await res.json();

    const events = json?.events || [];
    if (!events.length) throw new Error('No events');

    let ev = events[0];
    for (const e of events){
      const comp = e?.competitions?.[0];
      const ab = (comp?.competitors||[]).map(c => c?.team?.abbreviation).filter(Boolean);
      if (ab.includes('SEA') && (ab.includes('NE') || ab.includes('NWE') || ab.includes('NEP'))) { ev = e; break; }
    }

    const comp = ev.competitions?.[0];
    const st = comp?.status;
    const detail = st?.type?.detail || st?.type?.shortDetail || '';
    const period = st?.period || 0;

    const cSEA = (comp.competitors||[]).find(c => c?.team?.abbreviation === 'SEA' || (c?.team?.displayName||'').includes('Seahawks'));
    const cNE = (comp.competitors||[]).find(c => c?.team?.abbreviation === 'NE' || (c?.team?.displayName||'').includes('Patriots') || c?.team?.abbreviation==='NWE');
    if (!cSEA || !cNE) throw new Error('Teams not found');

    const seaTotal = parseInt(cSEA.score||0,10);
    const patTotal = parseInt(cNE.score||0,10);

    state.score.sea = seaTotal;
    state.score.pat = patTotal;
    state.auto.detail = detail;
    state.auto.lastFetch = now();
    state.statusText = `Auto score: ${seaTotal}-${patTotal} (${detail})`;

    const completed = !!st?.type?.completed;
    if (period >= 2 && !state.locks.q1) awardPeriod('q1', seaTotal, patTotal);
    if (period >= 3 && !state.locks.q2) awardPeriod('q2', seaTotal, patTotal);
    if (period >= 4 && !state.locks.q3) awardPeriod('q3', seaTotal, patTotal);
    if (completed && !state.locks.final) awardPeriod('final', seaTotal, patTotal);

    if (/halftime/i.test(detail)) state.statusText = `Halftime! Tap Frenzy available.`;
  }

  async function autoLoop(){
    if (mode !== 'host') return;
    try{ await fetchScore(); renderAll(); broadcast(); }
    catch(e){ state.statusText = `Auto score error: ${e.message || e}`; renderAll(); broadcast(); }
  }

  function setAuto(on){
    if (mode !== 'host') return;
    state.auto.enabled = on;
    $('autoBtn').textContent = on ? 'üõ∞Ô∏è Auto scores: ON' : 'üõ∞Ô∏è Auto scores: OFF';
    if (autoTimer) clearInterval(autoTimer);
    autoTimer = null;
    if (on){ autoLoop(); autoTimer = setInterval(autoLoop, 30000); }
    else { state.statusText = 'Auto scores off. Use manual score + lock buttons.'; broadcast(); }
    renderAll();
  }

  // Host start
  async function startHost(){
    mode = 'host';
    $('mode').classList.add('hidden');
    $('hostPanel').classList.remove('hidden');
    $('playArea').classList.remove('hidden');

    const room = code4();
    $('roomCode').textContent = room;
    $('meRoom').textContent = room;
    $('meName').textContent = '(Host)';
    $('meAvatar').textContent = 'üéôÔ∏è';

    my.lastRoom = room;
    saveProfile(my);

    state = newState(room);

    peer = new Peer(room, { debug: 1 });
    peer.on('open', () => { setNetChip('Hosting'); state.statusText = 'Room live. Players can join.'; renderAll(); });
    peer.on('connection', (c) => {
      c.on('data', (msg) => handleHostMsg(c, msg));
      c.on('close', () => {});
      c.on('error', peerError);
    });
    peer.on('error', peerError);

    setInterval(() => { if (mode==='host') { markOfflineSweeper(); broadcast(); renderLeaders(); } }, 5000);

    renderAll();
    broadcast();
    openRules();
  }

  function handleHostMsg(c, msg){
    if (!msg || typeof msg !== 'object') return;

    if (msg.t === 'join'){
      const token = msg.token;
      const name = msg.name || 'Player';
      const avatar = msg.avatar || 'üèà';
      upsertPlayer(token, name, avatar);
      conns.set(token, c);
      state.statusText = `${avatar} ${name} joined.`;
      c.send({ t:'state', state });
      broadcast();
      renderAll();
      return;
    }

    if (msg.t === 'ping'){
      const token = msg.token;
      if (state.players[token]) state.players[token].lastSeen = now();
      return;
    }

    if (msg.t === 'claim'){
      const token = msg.token;
      const key = msg.key;
      if (!state.players[token]) return;
      if (state.squares[key]) return;
      state.squares[key] = token;
      state.statusText = `${state.players[token].avatar} ${state.players[token].name} claimed ${key}.`;
      ding();
      broadcast();
      renderGrid();
      return;
    }

    if (msg.t === 'tap'){
      if (!state.mini?.active) return;
      const token = msg.token;
      if (!state.players[token]) return;
      state.mini.taps[token] = (state.mini.taps[token] || 0) + 1;
      return;
    }

    if (msg.t === 'request') c.send({ t:'state', state });
  }

  // Player connect + reconnect
  let reconnecting = false;
  let backoff = 900;
  let pingTimer = null;
  let lastWinnersSig = '';

  function showReconnect(show, msg=''){
    $('reconnectBanner').classList.toggle('hidden', !show);
    $('reconnectMsg').textContent = msg;
  }

  function winnersSignature(st){ return JSON.stringify(st.winners || {}); }

  function onNewState(st){
    const sig = winnersSignature(st);
    if (sig !== lastWinnersSig && lastWinnersSig){
      const oldW = JSON.parse(lastWinnersSig || '{}');
      const newW = st.winners || {};
      for (const per of PERIODS){
        if (!!newW[per] && !oldW[per]){
          const main = newW[per].main;
          const wp = main?.token ? st.players?.[main.token] : null;
          if (wp){
            cheer();
            fireConfetti(0.5);
            flyWinner(`${PERIOD_LABEL[per]} Winner: ${wp.avatar} ${wp.name}`);
          } else {
            ding();
          }
        }
      }
    }
    lastWinnersSig = sig;

    state = st;
    renderAll();

    if (state.mini?.active && state.mini.type==='tap') openMini();
    else closeMini();
  }

  async function connectAsPlayer(roomCode){
    mode = 'player';
    $('mode').classList.add('hidden');
    $('hostPanel').classList.add('hidden');
    $('playArea').classList.remove('hidden');

    $('meName').textContent = my.name;
    $('meAvatar').textContent = my.avatar;
    $('meRoom').textContent = roomCode;

    peer = new Peer(undefined, { debug: 0 });
    peer.on('open', () => { setNetChip('Connecting'); doConnect(roomCode); });
    peer.on('error', (e) => { peerError(e); tryReconnect(roomCode); });

    openRules();
  }

  function doConnect(roomCode){
    if (!peer) return;
    conn = peer.connect(roomCode, { reliable: true });

    conn.on('open', () => {
      setNetChip('Connected');
      reconnecting = false;
      backoff = 900;
      showReconnect(false);

      conn.send({ t:'join', token: my.token, name: my.name, avatar: my.avatar });
      conn.send({ t:'request' });

      if (pingTimer) clearInterval(pingTimer);
      pingTimer = setInterval(() => { if (conn?.open) conn.send({ t:'ping', token: my.token }); }, 8000);

      toast('Connected. Claim squares!');
    });

    conn.on('data', (msg) => { if (msg?.t === 'state' && msg.state) onNewState(msg.state); });
    conn.on('close', () => { setNetChip('Disconnected'); tryReconnect(roomCode); });
    conn.on('error', (e) => { peerError(e); tryReconnect(roomCode); });
  }

  async function tryReconnect(roomCode){
    if (reconnecting) return;
    reconnecting = true;
    showReconnect(true, 'Trying to rejoin‚Ä¶');

    while (reconnecting){
      try{
        if (!peer || peer.destroyed){
          peer = new Peer(undefined, { debug: 0 });
          await new Promise((res, rej) => { peer.on('open', res); peer.on('error', rej); });
        }
        doConnect(roomCode);
        await sleep(1400);
        if (conn?.open){ reconnecting = false; showReconnect(false); return; }
      } catch {}

      showReconnect(true, `Retrying in ${Math.round(backoff/100)/10}s‚Ä¶`);
      await sleep(backoff);
      backoff = Math.min(7000, Math.floor(backoff * 1.35));
    }
  }

  document.addEventListener('visibilitychange', () => {
    if (document.hidden) return;
    if (mode === 'player' && my.lastRoom){ if (!conn?.open) tryReconnect(my.lastRoom); }
  });
  window.addEventListener('online', () => {
    if (mode === 'player' && my.lastRoom && !conn?.open) tryReconnect(my.lastRoom);
  });

  // Mini game UI
  let miniLocalTaps = 0;
  let miniTimerRAF = null;

  function updateMiniTimer(){
    if (!state?.mini?.active){ $('miniTimer').textContent = '0'; return; }
    const leftMs = Math.max(0, state.mini.endsAt - now());
    $('miniTimer').textContent = String(Math.ceil(leftMs/1000));
    miniTimerRAF = requestAnimationFrame(updateMiniTimer);
  }

  $('tapBig').addEventListener('click', () => {
    if (soundEnabled) ensureAudio();
    if (!state?.mini?.active) return;
    miniLocalTaps++;
    $('myTaps').textContent = miniLocalTaps;
    beep(620, 0.05, 0.10);
    sendToHost({ t:'tap', token: my.token });
  });

  // Ensure mini timer loop starts when mini opens
  const _openMini = openMini;
  openMini = function(){ _openMini(); $('myTaps').textContent = miniLocalTaps; if (miniTimerRAF) cancelAnimationFrame(miniTimerRAF); miniTimerRAF = requestAnimationFrame(updateMiniTimer); };
  const _closeMini = closeMini;
  closeMini = function(){ _closeMini(); if (miniTimerRAF) cancelAnimationFrame(miniTimerRAF); miniTimerRAF = null; };

  // Menu actions
  $('hostBtn').addEventListener('click', startHost);
  $('joinBtn').addEventListener('click', () => { toast('Fill name + avatar, then enter code and connect.'); });

  $('joinNowBtn').addEventListener('click', () => {
    const nm = ($('nameInput').value || '').trim();
    const cd = ($('codeInput').value || '').trim().toUpperCase();
    if (!nm) { toast('Enter your name.','err'); return; }
    if (cd.length !== 4) { toast('Enter the 4-letter code.','err'); return; }
    my.name = nm.slice(0,18);
    my.lastRoom = cd;
    saveProfile(my);
    connectAsPlayer(cd);
  });

  // Host controls
  $('shuffleBtn').addEventListener('click', () => {
    if (mode !== 'host') return;
    state.numbers.sea = shuffle([0,1,2,3,4,5,6,7,8,9]);
    state.numbers.pat = shuffle([0,1,2,3,4,5,6,7,8,9]);
    state.statusText = 'Numbers shuffled. Players can claim squares.';
    broadcast();
    renderGrid();
    toast('Numbers shuffled.');
  });

  $('autoBtn').addEventListener('click', () => { if (mode === 'host') setAuto(!state.auto.enabled); });
  $('tapBtn').addEventListener('click', () => { if (mode === 'host') startMini(10); });

  $('resetRoomBtn').addEventListener('click', () => {
    if (mode !== 'host') return;
    if (!confirm('Reset the room? This clears squares, numbers, locks, winners, and points.')) return;
    const room = state.roomCode;
    state = newState(room);
    state.statusText = 'Room reset. Shuffle numbers to start.';
    broadcast();
    renderAll();
  });

  $('applyManual').addEventListener('click', () => {
    if (mode !== 'host') return;
    const s = clamp(parseInt($('manualSea').value||0,10)||0, 0, 99);
    const p = clamp(parseInt($('manualPat').value||0,10)||0, 0, 99);
    state.score.sea = s;
    state.score.pat = p;
    state.statusText = `Manual score: ${s}-${p}. Lock a period when appropriate.`;
    broadcast();
    renderScore();
  });

  $('bonusCount').addEventListener('input', () => {
    if (mode !== 'host') return;
    state.settings.bonusPer = clamp(parseInt($('bonusCount').value||0,10)||0, 0, 5);
    broadcast();
  });

  $('lockQ1').addEventListener('click', () => { if(mode==='host') { awardPeriod('q1', state.score.sea, state.score.pat); broadcast(); renderAll(); } });
  $('lockQ2').addEventListener('click', () => { if(mode==='host') { awardPeriod('q2', state.score.sea, state.score.pat); broadcast(); renderAll(); } });
  $('lockQ3').addEventListener('click', () => { if(mode==='host') { awardPeriod('q3', state.score.sea, state.score.pat); broadcast(); renderAll(); } });
  $('lockF').addEventListener('click',  () => { if(mode==='host') { awardPeriod('final', state.score.sea, state.score.pat); broadcast(); renderAll(); } });

  // Start: fill UI
  setNetChip('Idle');
  renderPrizeDeck();

})();
</script>
</body>
</html>
